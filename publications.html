<div id="publications"></div>

<script>
fetch("/.netlify/functions/pubmed")
  .then(res => res.text())
  .then(xmlText => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, "text/xml");
    const items = Array.from(xml.querySelectorAll("item"));

    const pubsByYear = {};

    items.forEach(item => {
      const title = item.querySelector("title")?.textContent || "";
      const link = item.querySelector("link")?.textContent || "";
      const pubDate = item.querySelector("pubDate")?.textContent || "";

      // Extract year
      const yearMatch = pubDate.match(/\d{4}/);
      const year = yearMatch ? yearMatch[0] : "Unknown";

      // Extract DOI if present in description
      const rawDesc = item.querySelector("description")?.textContent || "";
      const doiMatch = rawDesc.match(/doi:\s*(10\.\d{4,9}\/[^\s]+)/i);
      const doi = doiMatch ? doiMatch[1].replace(/\.$/, "") : null;

      // Get authors from dc:creator (usually comma-separated)
      const authorsNode = item.querySelector("dc\\:creator");
      const authors = authorsNode ? authorsNode.textContent : "";

      // Get journal from source node
      const journalNode = item.querySelector("source");
      const journal = journalNode ? journalNode.textContent : "";

      if (!pubsByYear[year]) pubsByYear[year] = [];

      pubsByYear[year].push({
        title,
        link,
        authors,
        journal,
        doi
      });
    });

    const sortedYears = Object.keys(pubsByYear)
      .filter(y => y !== "Unknown")
      .sort((a, b) => b - a);

    const container = document.getElementById("publications");
    container.innerHTML = "";

    sortedYears.forEach(year => {
      const h2 = document.createElement("h2");
      h2.textContent = year;
      container.appendChild(h2);

      const ul = document.createElement("ul");

      pubsByYear[year].forEach(pub => {
        const li = document.createElement("li");

        li.innerHTML = `
          <strong>${pub.authors}.</strong><br>
          <span style="color: green; font-weight: bold;">
            ${pub.journal.toUpperCase()}
          </span><br>
          ${pub.title}. 
          <a href="${pub.link}" target="_blank">PubMed</a>
          ${pub.doi ? ` | <a href="https://doi.org/${pub.doi}" target="_blank">DOI</a>` : ""}
        `;

        ul.appendChild(li);
      });

      container.appendChild(ul);
    });
  })
  .catch(() => {
    document.getElementById("publications").innerHTML =
      "<p>Error loading publications.</p>";
  });
</script>
